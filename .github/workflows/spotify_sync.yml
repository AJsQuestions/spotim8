name: Spotify Sync

on:
  # Run daily at 6am PT (14:00 UTC)
  schedule:
    - cron: '0 14 * * *'
  
  # Allow manual trigger
  workflow_dispatch:

# Allow the workflow to push commits
permissions:
  contents: write

jobs:
  sync-and-update:
    runs-on: ubuntu-latest
    timeout-minutes: 720
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Shallow fetch to speed up checkout; set to 0 if full history is required
          fetch-depth: 1
      
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pip/wheels
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Restore wheelhouse cache
        uses: actions/cache@v4
        with:
          path: ./.wheelhouse
          key: ${{ runner.os }}-wheels-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-wheels-
      
      - name: Install git-crypt (if missing)
        run: |
          if command -v git-crypt >/dev/null 2>&1; then
            echo "git-crypt already installed"
          else
            sudo apt-get update
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y git-crypt
          fi
      
      - name: Unlock encrypted files
        run: |
          echo "${{ secrets.GIT_CRYPT_KEY }}" | base64 -d > /tmp/git-crypt-key
          git-crypt unlock /tmp/git-crypt-key
          rm /tmp/git-crypt-key
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          # Build wheelhouse only if cache is empty
          if [ -d ./.wheelhouse ] && [ "$(ls -A ./.wheelhouse)" ]; then
            echo "Using cached wheelhouse"
          else
            echo "Building wheels into ./.wheelhouse"
            pip wheel -r requirements.txt -w ./.wheelhouse
          fi
          # Install from local wheelhouse to avoid rebuilds; fall back to PyPI if needed
          pip install --no-index --find-links ./.wheelhouse -r requirements.txt || pip install -r requirements.txt
          pip install -e .

      - name: Data size diagnostics
        run: |
          echo "Workspace size:" && du -sh . || true
          echo "Data dir size:" && du -sh data || true
          echo "Parquet files:" && ls -lh data/*.parquet || true
      
      - name: Show existing data status
        run: |
          echo "Checking for existing parquet files..."
          if ls data/*.parquet 1>/dev/null 2>&1; then
            echo "Found existing parquet files:"
            ls -lh data/*.parquet
          else
            echo "No parquet files found - will do full sync"
          fi
      
      - name: Sync library and update playlists
        env:
          # Required secrets
          SPOTIPY_CLIENT_ID: ${{ secrets.SPOTIPY_CLIENT_ID }}
          SPOTIPY_CLIENT_SECRET: ${{ secrets.SPOTIPY_CLIENT_SECRET }}
          SPOTIPY_REDIRECT_URI: ${{ secrets.SPOTIPY_REDIRECT_URI }}
          SPOTIPY_REFRESH_TOKEN: ${{ secrets.SPOTIPY_REFRESH_TOKEN }}
          # Optional: customize playlist naming 
          PLAYLIST_OWNER_NAME: ${{ secrets.PLAYLIST_OWNER_NAME }}
          PLAYLIST_PREFIX: ${{ secrets.PLAYLIST_PREFIX }}
        # Use `time` to measure duration in CI logs and help pinpoint slow steps
        run: |
          time python scripts/spotify_sync.py
      
      - name: Commit updated parquet files
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add only parquet files (not meta.json or cache)
          git add data/*.parquet || true
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to parquet files"
          else
            echo "Committing updated parquet files..."
            git commit -m "chore: sync spotify library data [skip ci]"
            git push
            echo "Changes pushed to repository"
          fi
